<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Click Logger</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html, body { height: 100%; margin: 0; font-family: 'Inter', sans-serif; }
        .timer-display { font-variant-numeric: tabular-nums; }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 dark:bg-gray-900 flex items-center justify-center h-full">

    <div class="text-center p-8 flex flex-col items-center">
        <!-- Afficheur du minuteur -->
        <div id="timer" class="mb-8 timer-display text-5xl md:text-7xl font-bold text-gray-400 dark:text-gray-600">
            <span id="timerSign"></span>
            <span id="timerValue">--:--:--</span>
        </div>

        <!-- Bouton d'action -->
        <button id="logButton" class="w-48 h-48 bg-blue-600 text-white rounded-full shadow-lg transform transition-all duration-200 ease-in-out hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300 dark:focus:ring-blue-800 flex items-center justify-center">
            <span id="buttonText" class="text-2xl font-semibold">Nicotine</span>
        </button>
    </div>

    <!-- Zone d'affichage pour le débogage -->
    <div id="debugLog" class="fixed bottom-0 left-0 w-full bg-gray-800 text-white p-3 text-xs font-mono break-words">
        En attente d'une action...
    </div>

    <script>
        // --- CONFIGURATION ---
        const APPS_SCRIPT_URL = 'VOTRE_URL_APPS_SCRIPT_ICI'; 

        // --- ÉLÉMENTS DU DOM ---
        const logButton = document.getElementById('logButton');
        const buttonText = document.getElementById('buttonText');
        const timerEl = document.getElementById('timer');
        const timerSignEl = document.getElementById('timerSign');
        const timerValueEl = document.getElementById('timerValue');
        const debugLogEl = document.getElementById('debugLog'); // Ajout de l'élément de log

        let timerInterval;

        // --- FONCTION DE DÉBOGAGE ---
        function logToScreen(message) {
            debugLogEl.textContent = message;
        }

        // --- FONCTIONS DU MINUTEUR ---
        function formatTime(totalSeconds) {
            const absSeconds = Math.abs(totalSeconds);
            const h = Math.floor(absSeconds / 3600).toString().padStart(2, '0');
            const m = Math.floor((absSeconds % 3600) / 60).toString().padStart(2, '0');
            const s = Math.floor(absSeconds % 60).toString().padStart(2, '0');
            return `${h}:${m}:${s}`;
        }

        function updateTimerDisplay() {
            const lastClickTimestamp = localStorage.getItem('lastClickTimestamp');
            const countdownDuration = localStorage.getItem('countdownDuration');
            if (!lastClickTimestamp || !countdownDuration) return;
            const elapsedSeconds = Math.floor((Date.now() - parseInt(lastClickTimestamp)) / 1000);
            const remainingSeconds = parseInt(countdownDuration) - elapsedSeconds;
            if (remainingSeconds > 0) {
                timerEl.classList.remove('text-green-500', 'dark:text-green-400', 'text-gray-400', 'dark:text-gray-600');
                timerEl.classList.add('text-red-500', 'dark:text-red-400');
                timerSignEl.textContent = '-';
                timerValueEl.textContent = formatTime(remainingSeconds);
            } else {
                timerEl.classList.remove('text-red-500', 'dark:text-red-400', 'text-gray-400', 'dark:text-gray-600');
                timerEl.classList.add('text-green-500', 'dark:text-green-400');
                timerSignEl.textContent = '+';
                timerValueEl.textContent = formatTime(remainingSeconds);
            }
        }

        function startTimer() {
            clearInterval(timerInterval);
            updateTimerDisplay();
            timerInterval = setInterval(updateTimerDisplay, 1000);
        }

        // --- GESTION DU CLIC ---
        logButton.addEventListener('click', () => {
            logButton.disabled = true;
            buttonText.textContent = '...';
            logToScreen('Appel du script en cours...');

            fetch(APPS_SCRIPT_URL)
                .then(response => {
                    if (!response.ok) {
                        // Gère les erreurs HTTP qui ne sont pas capturées par .catch (ex: 404, 500)
                        throw new Error(`Erreur HTTP! Statut: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    logToScreen('Succès: ' + JSON.stringify(data)); // Affiche la réponse complète
                    if (data.status === 'success' && data.averageDuration !== undefined) {
                        localStorage.setItem('lastClickTimestamp', Date.now());
                        localStorage.setItem('countdownDuration', data.averageDuration);
                        startTimer();
                        logButton.classList.remove('bg-blue-600');
                        logButton.classList.add('bg-green-500');
                    } else {
                        throw new Error("La réponse du script est invalide ou manque 'averageDuration'.");
                    }
                })
                .catch(error => {
                    logToScreen('Erreur: ' + error.toString()); // Affiche l'erreur à l'écran
                    logButton.classList.remove('bg-blue-600');
                    logButton.classList.add('bg-red-500');
                })
                .finally(() => {
                    setTimeout(() => {
                        logButton.disabled = false;
                        buttonText.textContent = 'Nicotine';
                        logButton.classList.remove('bg-green-500', 'bg-red-500');
                        logButton.classList.add('bg-blue-600');
                    }, 1000);
                });
        });

        // --- INITIALISATION ---
        window.addEventListener('load', () => {
            if (localStorage.getItem('lastClickTimestamp')) {
                startTimer();
            }
        });
    </script>
</body>
</html>
